# 前端中断处理优化说明

## 问题描述

之前的前端实现中，当 LangGraph agent 触发中断（interrupt）时，用户在界面输入 "approve" 等文本会被当作新消息发送，导致工具调用被取消。

## 解决方案

### 1. 新增组件：InterruptActions

创建了专门的中断处理组件 `src/app/components/InterruptActions.tsx`，提供三个操作按钮：

- **批准（Approve）**：执行原始的工具调用
- **编辑（Edit）**：修改工具参数后执行
- **拒绝（Reject）**：取消工具调用

#### 组件特性

1. **自动解析中断数据**：支持 LangGraph 的 HITLRequest 格式
2. **参数展示**：清晰显示工具名称和参数
3. **编辑功能**：可展开编辑每个参数
4. **拒绝原因**：可选填写拒绝原因

### 2. 修改 ChatInterface 组件

在 `src/app/components/ChatInterface.tsx` 中：

#### 添加的导入
```typescript
import { InterruptActions } from "@/app/components/InterruptActions";
```

#### 添加的回调函数

```typescript
// 批准操作
const handleInterruptApprove = useCallback(() => {
  if (!interrupt) return;
  
  const interruptId = interrupt.id;
  const resumePayload = {
    [interruptId]: {
      decisions: [{ type: "approve" }],
    },
  };
  
  sendHumanResponse(resumePayload);
}, [interrupt, sendHumanResponse]);

// 拒绝操作
const handleInterruptReject = useCallback((message?: string) => {
  if (!interrupt) return;
  
  const interruptId = interrupt.id;
  const resumePayload = {
    [interruptId]: {
      decisions: [
        {
          type: "reject",
          message: message || "用户拒绝了此操作",
        },
      ],
    },
  };
  
  sendHumanResponse(resumePayload);
}, [interrupt, sendHumanResponse]);

// 编辑操作
const handleInterruptEdit = useCallback((editedArgs: Record<string, any>) => {
  if (!interrupt) return;
  
  const interruptId = interrupt.id;
  const resumePayload = {
    [interruptId]: {
      decisions: [
        {
          type: "edit",
          args: editedArgs,
        },
      ],
    },
  };
  
  sendHumanResponse(resumePayload);
}, [interrupt, sendHumanResponse]);
```

#### 渲染中断组件

```typescript
{interrupt && (
  <div className="mt-4">
    {debugMode ? (
      <Button onClick={handleContinue}>继续</Button>
    ) : (
      <InterruptActions
        interrupt={interrupt}
        onApprove={handleInterruptApprove}
        onReject={handleInterruptReject}
        onEdit={handleInterruptEdit}
        isLoading={isLoading}
      />
    )}
  </div>
)}
```

### 3. 修改 useChat Hook

在 `src/app/hooks/useChat.ts` 中：

```typescript
const sendHumanResponse = useCallback(
  (response: HumanResponse[] | Record<string, any>) => {
    // 支持两种格式：
    // 1. 旧格式：HumanResponse[]
    // 2. 新格式：HITLResponse (LangGraph 标准格式)
    stream.submit(null, { command: { resume: response } });
    onHistoryRevalidate?.();
  },
  [stream, onHistoryRevalidate]
);
```

## 数据流程

### 1. 中断发生

```
Agent 执行 -> 触发 write_file 工具 -> 生成 Interrupt 对象
```

Interrupt 对象结构：
```typescript
{
  id: "interrupt_id_xxx",
  value: {
    action_requests: [
      {
        name: "write_file",
        args: { file_path: "/test.txt", content: "Hello" },
        description: "写入文件"
      }
    ]
  }
}
```

### 2. 用户操作

用户点击按钮 -> 触发回调函数 -> 构建 HITLResponse

### 3. 恢复执行

```typescript
// HITLResponse 格式
{
  "<interrupt_id>": {
    decisions: [
      { type: "approve" }  // 或 "reject" 或 "edit"
    ]
  }
}

// 发送 Command
stream.submit(null, { command: { resume: HITLResponse } })
```

## 使用方式

### 用户视角

1. **触发中断**：Agent 执行需要批准的操作时，界面会显示橙色的批准框
2. **查看信息**：显示工具名称、参数和描述
3. **选择操作**：
   - 点击"批准"：直接执行
   - 点击"编辑"：展开编辑表单，修改参数后确认
   - 点击"拒绝"：可选填写拒绝原因后确认

### 开发者视角

如果需要自定义中断处理逻辑：

```typescript
// 在 ChatInterface 或其他组件中
const handleCustomInterrupt = useCallback(() => {
  if (!interrupt) return;
  
  // 自定义逻辑
  const customPayload = {
    [interrupt.id]: {
      decisions: [
        {
          type: "approve",
          // 可以添加其他自定义字段
        }
      ]
    }
  };
  
  sendHumanResponse(customPayload);
}, [interrupt, sendHumanResponse]);
```

## 测试建议

1. **基本批准流程**：
   - 发送消息触发 write_file
   - 点击"批准"按钮
   - 验证文件是否成功写入

2. **编辑流程**：
   - 触发中断
   - 点击"编辑"
   - 修改参数（如文件路径或内容）
   - 确认编辑
   - 验证使用修改后的参数执行

3. **拒绝流程**：
   - 触发中断
   - 点击"拒绝"
   - 填写拒绝原因
   - 确认拒绝
   - 验证 agent 收到拒绝消息并重新规划

## 注意事项

1. **不要在聊天框输入文本**：批准/拒绝操作必须通过按钮完成
2. **中断 ID 很重要**：每个中断都有唯一 ID，必须在 resume 时使用
3. **参数格式**：编辑时注意保持参数的正确格式（JSON）
4. **调试模式**：在 debugMode 下仍然显示旧的"继续"按钮

## 相关文件

- `src/app/components/InterruptActions.tsx` - 中断操作组件
- `src/app/components/ChatInterface.tsx` - 聊天界面（集成中断处理）
- `src/app/hooks/useChat.ts` - Chat Hook（发送 resume 命令）
- `src/app/types/inbox.ts` - 类型定义

