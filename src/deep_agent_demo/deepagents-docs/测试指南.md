# 中断处理功能测试指南

## 前置条件

1. **启动 LangGraph API 服务器**
   ```bash
   cd deepagents_agent
   langgraph dev
   ```
   
   确保服务运行在 `http://localhost:8123`

2. **启动前端开发服务器**
   ```bash
   npm run dev
   ```
   
   访问 `http://localhost:3000`

3. **配置前端**
   - 点击"设置"按钮
   - 配置 Deployment URL: `http://localhost:8123`
   - 配置 Assistant ID: `agent`（或你的 agent ID）
   - 保存配置

## 测试场景

### 场景 1：批准（Approve）操作

#### 步骤

1. 在聊天框输入：
   ```
   请在 /test.txt 写入内容：Hello World
   ```

2. 观察界面变化：
   - ✅ 应该显示橙色的"需要人工批准"框
   - ✅ 显示工具名称：`write_file`
   - ✅ 显示参数：`file_path` 和 `content`
   - ✅ 显示三个按钮：批准、编辑、拒绝

3. 点击"批准"按钮

4. 验证结果：
   - ✅ 中断框消失
   - ✅ Agent 继续执行
   - ✅ 显示成功消息
   - ✅ 文件被创建（可以通过后续消息验证）

#### 预期行为

- **不应该**：显示错误 "Tool call was cancelled"
- **应该**：工具调用成功执行

---

### 场景 2：编辑（Edit）操作

#### 步骤

1. 在聊天框输入：
   ```
   请在 /original.txt 写入内容：Original Content
   ```

2. 等待中断框出现

3. 点击"编辑"按钮

4. 观察编辑表单：
   - ✅ 显示所有参数的可编辑字段
   - ✅ 每个参数可以展开/折叠

5. 展开 `file_path` 参数

6. 修改值为：`/modified.txt`

7. 展开 `content` 参数

8. 修改值为：`Modified Content`

9. 点击"确认编辑"按钮

10. 验证结果：
    - ✅ 使用修改后的参数执行
    - ✅ 创建的文件是 `/modified.txt`
    - ✅ 内容是 `Modified Content`

#### 预期行为

- **不应该**：使用原始参数
- **应该**：使用编辑后的参数执行

---

### 场景 3：拒绝（Reject）操作

#### 步骤

1. 在聊天框输入：
   ```
   请删除 /important.txt 文件
   ```

2. 等待中断框出现

3. 点击"拒绝"按钮

4. 观察拒绝表单：
   - ✅ 显示文本框用于输入拒绝原因

5. 输入拒绝原因：
   ```
   这是重要文件，不能删除
   ```

6. 点击"确认拒绝"按钮

7. 验证结果：
   - ✅ 工具调用被取消
   - ✅ Agent 收到拒绝消息
   - ✅ Agent 可能会重新规划或询问用户

#### 预期行为

- **不应该**：执行删除操作
- **应该**：取消操作并通知 agent

---

### 场景 4：多个参数编辑

#### 步骤

1. 触发一个有多个参数的工具调用

2. 点击"编辑"按钮

3. 逐个展开并编辑多个参数

4. 确认编辑

5. 验证所有参数都被正确修改

---

### 场景 5：取消编辑/拒绝

#### 步骤

1. 触发中断

2. 点击"编辑"按钮

3. 点击"取消"按钮

4. 验证：
   - ✅ 返回到初始状态
   - ✅ 显示三个操作按钮

5. 点击"拒绝"按钮

6. 点击"取消"按钮

7. 验证：
   - ✅ 返回到初始状态
   - ✅ 显示三个操作按钮

---

## 调试技巧

### 1. 查看浏览器控制台

打开浏览器开发者工具（F12），查看 Console 标签：

```javascript
// 应该看到类似的日志
ChatInterface state: { threadId: "...", isLoading: false, ... }
Stream finished, revalidating history
```

### 2. 查看网络请求

在 Network 标签中：

1. 筛选 XHR/Fetch 请求
2. 查找发送到 LangGraph API 的请求
3. 检查请求体中的 `command.resume` 字段

正确的请求体应该类似：
```json
{
  "command": {
    "resume": {
      "interrupt_id_xxx": {
        "decisions": [
          { "type": "approve" }
        ]
      }
    }
  }
}
```

### 3. 检查中断数据

在 `InterruptActions` 组件中添加临时日志：

```typescript
console.log('Interrupt data:', interrupt);
console.log('Interrupt ID:', interrupt.id);
console.log('Interrupt value:', interrupt.value);
```

### 4. 验证后端配置

确保 `backend_example.py` 中的配置正确：

```python
interrupt_on = {
    "write_file": True,  # 或具体的配置
}
```

---

## 常见问题

### Q1: 点击按钮后没有反应

**可能原因**：
- 检查浏览器控制台是否有错误
- 检查 `sendHumanResponse` 是否正确调用
- 检查网络请求是否发送

**解决方法**：
- 查看控制台错误信息
- 添加 `console.log` 调试
- 检查 LangGraph API 服务是否正常运行

### Q2: 仍然显示 "Tool call was cancelled" 错误

**可能原因**：
- 请求格式不正确
- Interrupt ID 不匹配
- 后端配置问题

**解决方法**：
- 检查网络请求中的 `resume` 格式
- 确认 interrupt ID 正确
- 查看 LangGraph API 日志

### Q3: 点击拒绝后，agent 又重新尝试执行相同的工具调用

**问题描述**：
这是 LangChain 1.0.3 的一个已知 bug（GitHub issue #33787）。当你拒绝一个工具调用后，agent 会重新评估状态，认为原始任务仍未完成，然后再次尝试执行相同的工具调用。

**解决方法**：
在 agent 的系统提示中添加明确的指令，告诉 agent 不要重试被拒绝的操作：

```python
system_prompt = """
## 重要：关于工具调用批准

某些工具调用需要用户批准才能执行。当工具调用被用户拒绝时：
1. **立即接受用户的决定** - 不要重试相同的命令
2. 解释你理解他们拒绝了该操作
3. 建议替代方法或请求澄清
4. **永远不要再次尝试完全相同的被拒绝命令**

尊重用户的决定并与他们协作。
"""

agent = create_deep_agent(
    system_prompt=system_prompt,
    interrupt_on=interrupt_on
)
```

这个方法已经在 `backend_example.py` 中实现。

### Q3: 编辑后参数格式错误

**可能原因**：
- JSON 格式不正确
- 参数类型不匹配

**解决方法**：
- 在编辑框中输入有效的 JSON
- 检查参数类型（字符串、数字、对象等）

---

## 成功标准

所有测试场景通过后，应该满足：

- ✅ 批准操作能正常执行工具调用
- ✅ 编辑操作能使用修改后的参数
- ✅ 拒绝操作能取消工具调用
- ✅ 不再出现 "Tool call was cancelled" 错误
- ✅ 界面交互流畅，无明显延迟
- ✅ 错误处理正确，有友好的提示信息

---

## 下一步

测试通过后，可以：

1. 添加更多工具的中断配置
2. 自定义中断界面样式
3. 添加更复杂的参数验证
4. 实现批量批准功能（如果有多个中断）

