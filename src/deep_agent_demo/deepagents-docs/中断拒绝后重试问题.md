# ä¸­æ–­æ‹’ç»å Agent é‡è¯•é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

### ç°è±¡

å½“ä½¿ç”¨ LangGraph çš„ Human-in-the-Loop (HITL) ä¸­é—´ä»¶æ—¶ï¼Œå¦‚æœç”¨æˆ·**æ‹’ç»**ä¸€ä¸ªå·¥å…·è°ƒç”¨ï¼Œagent ä¼šï¼š

1. æ¥æ”¶æ‹’ç»å†³ç­–
2. é‡æ–°è¯„ä¼°å½“å‰çŠ¶æ€
3. çœ‹åˆ°åŸå§‹ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¦‚"å†™å…¥æ–‡ä»¶åˆ° /test.txt"ï¼‰
4. è®¤ä¸ºä»»åŠ¡ä»æœªå®Œæˆ
5. **å†æ¬¡ç”Ÿæˆç›¸åŒçš„å·¥å…·è°ƒç”¨**
6. å†æ¬¡è§¦å‘ä¸­æ–­ï¼Œè¦æ±‚ç”¨æˆ·æ‰¹å‡†

è¿™å¯¼è‡´ä¸€ä¸ªæ— é™å¾ªç¯ï¼šç”¨æˆ·æ‹’ç» â†’ agent é‡è¯• â†’ å†æ¬¡ä¸­æ–­ â†’ ç”¨æˆ·å†æ¬¡æ‹’ç» â†’ ...

### ç¤ºä¾‹

```
ç”¨æˆ·: è¯·åœ¨ /important.txt å†™å…¥å†…å®¹ï¼šTest
  â†“
Agent: å‡†å¤‡è°ƒç”¨ write_file("/important.txt", "Test")
  â†“
[ä¸­æ–­] éœ€è¦æ‰¹å‡†
  â†“
ç”¨æˆ·: [ç‚¹å‡»æ‹’ç»]
  â†“
Agent: æ”¶åˆ°æ‹’ç»ï¼Œé‡æ–°è¯„ä¼°...
Agent: ç”¨æˆ·è¦æ±‚å†™å…¥ /important.txtï¼Œä½†è¿˜æ²¡å®Œæˆ
Agent: å‡†å¤‡è°ƒç”¨ write_file("/important.txt", "Test")  â† åˆæ˜¯ç›¸åŒçš„è°ƒç”¨ï¼
  â†“
[ä¸­æ–­] éœ€è¦æ‰¹å‡†  â† åˆå›åˆ°äº†è¿™é‡Œï¼
```

## æ ¹æœ¬åŸå› 

è¿™æ˜¯ **LangChain 1.0.3 çš„å·²çŸ¥ bug**ï¼Œå·²åœ¨ GitHub issue #33787 ä¸­æŠ¥å‘Šã€‚

### æŠ€æœ¯åŸå› 

1. **çŠ¶æ€æŒä¹…åŒ–é—®é¢˜**ï¼š
   - Agent çš„çŠ¶æ€åŒ…å«åŸå§‹ç”¨æˆ·æ¶ˆæ¯
   - æ‹’ç»å†³ç­–ä¸ä¼šä¿®æ”¹æˆ–æ ‡è®°åŸå§‹æ¶ˆæ¯
   - Agent é‡æ–°è¯„ä¼°æ—¶ï¼Œä»ç„¶çœ‹åˆ°"æœªå®Œæˆ"çš„ä»»åŠ¡

2. **ç¼ºå°‘ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼š
   - Agent ä¸çŸ¥é“æŸä¸ªå·¥å…·è°ƒç”¨å·²ç»è¢«æ‹’ç»
   - æ²¡æœ‰æœºåˆ¶å‘Šè¯‰ agent "è¿™ä¸ªæ“ä½œå·²ç»è¢«ç”¨æˆ·æ˜ç¡®æ‹’ç»"

3. **LLM çš„æ¨ç†é€»è¾‘**ï¼š
   - LLM çœ‹åˆ°ç”¨æˆ·è¯·æ±‚ï¼š"å†™å…¥æ–‡ä»¶"
   - LLM çœ‹åˆ°æ²¡æœ‰æˆåŠŸçš„ ToolMessage
   - LLM æ¨ç†ï¼šä»»åŠ¡æœªå®Œæˆï¼Œéœ€è¦é‡è¯•

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç³»ç»Ÿæç¤ºæŒ‡ä»¤ï¼ˆæ¨èï¼‰âœ…

åœ¨ agent çš„ç³»ç»Ÿæç¤ºä¸­æ·»åŠ æ˜ç¡®çš„æŒ‡ä»¤ï¼Œå‘Šè¯‰ LLM ä¸è¦é‡è¯•è¢«æ‹’ç»çš„æ“ä½œã€‚

#### å®ç°ä»£ç 

```python
system_prompt = """
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚

## é‡è¦ï¼šå…³äºå·¥å…·è°ƒç”¨æ‰¹å‡†

æŸäº›å·¥å…·è°ƒç”¨éœ€è¦ç”¨æˆ·æ‰¹å‡†æ‰èƒ½æ‰§è¡Œã€‚å½“å·¥å…·è°ƒç”¨è¢«ç”¨æˆ·æ‹’ç»æ—¶ï¼š

1. **ç«‹å³æ¥å—ç”¨æˆ·çš„å†³å®š** - ä¸è¦é‡è¯•ç›¸åŒçš„å‘½ä»¤
2. è§£é‡Šä½ ç†è§£ä»–ä»¬æ‹’ç»äº†è¯¥æ“ä½œ
3. å»ºè®®æ›¿ä»£æ–¹æ³•æˆ–è¯·æ±‚æ¾„æ¸…
4. **æ°¸è¿œä¸è¦å†æ¬¡å°è¯•å®Œå…¨ç›¸åŒçš„è¢«æ‹’ç»å‘½ä»¤**

å°Šé‡ç”¨æˆ·çš„å†³å®šå¹¶ä¸ä»–ä»¬åä½œã€‚

ç¤ºä¾‹ï¼š
- âŒ é”™è¯¯ï¼šç”¨æˆ·æ‹’ç»äº† write_fileï¼Œç„¶åä½ åˆå°è¯• write_file
- âœ… æ­£ç¡®ï¼šç”¨æˆ·æ‹’ç»äº† write_fileï¼Œä½ è¯´"æˆ‘ç†è§£æ‚¨ä¸æƒ³å†™å…¥è¯¥æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥å°è¯•å…¶ä»–æ–¹æ³•å—ï¼Ÿ"
"""

agent = create_deep_agent(
    model=model,
    system_prompt=system_prompt,
    interrupt_on={"write_file": True}
)
```

#### ä¼˜ç‚¹
- âœ… ç®€å•æ˜“å®ç°
- âœ… ä¸éœ€è¦ä¿®æ”¹æ¡†æ¶ä»£ç 
- âœ… å·²åœ¨ DeepAgents CLI ä¸­éªŒè¯æœ‰æ•ˆ
- âœ… é€‚ç”¨äºæ‰€æœ‰ LLM

#### ç¼ºç‚¹
- âš ï¸ ä¾èµ– LLM çš„ç†è§£èƒ½åŠ›
- âš ï¸ ä¸æ˜¯ 100% ä¿è¯ï¼ˆLLM å¯èƒ½ä»ç„¶é‡è¯•ï¼‰

### æ–¹æ¡ˆ 2ï¼šç­‰å¾… LangChain å®˜æ–¹ä¿®å¤

LangChain å›¢é˜Ÿæ­£åœ¨ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼ˆPR #33789ï¼‰ã€‚

#### ä¿®å¤æ–¹æ¡ˆ

å®˜æ–¹ä¿®å¤ä¼šåœ¨æ‹’ç»å†³ç­–åæ³¨å…¥ä¸€ä¸ªä¸Šä¸‹æ–‡æ¶ˆæ¯ï¼š

```python
# ç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ è¿™æ ·çš„æ¶ˆæ¯
AIMessage(
    name="human_review_system",
    content="""
    åŸå§‹è¯·æ±‚çš„æ“ä½œï¼šwrite_file("/important.txt", "Test")
    ç”¨æˆ·å†³å®šï¼šæ‹’ç»
    åŸå› ï¼šè¿™æ˜¯é‡è¦æ–‡ä»¶ï¼Œä¸èƒ½åˆ é™¤
    
    ç³»ç»Ÿå·²å–æ¶ˆè¯¥æ“ä½œã€‚è¯·ä¸è¦é‡è¯•ç›¸åŒçš„æ“ä½œã€‚
    """
)
```

#### çŠ¶æ€

- ğŸ”§ PR #33789 å·²æäº¤
- â³ ç­‰å¾…å®¡æ ¸å’Œåˆå¹¶
- ğŸ“¦ é¢„è®¡åœ¨ LangChain 1.0.4+ ç‰ˆæœ¬ä¸­å‘å¸ƒ

#### å¦‚ä½•ä½¿ç”¨

ç­‰å¾…å®˜æ–¹å‘å¸ƒåï¼Œå‡çº§ LangChainï¼š

```bash
pip install --upgrade langchain>=1.0.4
```

### æ–¹æ¡ˆ 3ï¼šå‰ç«¯ç¦ç”¨æ‹’ç»æŒ‰é’®ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœç³»ç»Ÿæç¤ºæ–¹æ¡ˆæ•ˆæœä¸å¥½ï¼Œå¯ä»¥æš‚æ—¶åœ¨å‰ç«¯ç¦ç”¨æ‹’ç»åŠŸèƒ½ã€‚

```typescript
// åœ¨ InterruptActions ç»„ä»¶ä¸­
<Button
  onClick={() => setShowRejectForm(true)}
  disabled={true}  // æš‚æ—¶ç¦ç”¨
  size="sm"
  variant="destructive"
  className="flex-1"
>
  <XCircle size={14} className="mr-1" />
  æ‹’ç»ï¼ˆæš‚ä¸å¯ç”¨ï¼‰
</Button>
```

## å½“å‰å®ç°

### backend_example.py

å·²ç»åœ¨ `deepagents_agent/backend_example.py` ä¸­å®ç°äº†æ–¹æ¡ˆ 1ï¼š

```python
system_prompt = """å¦‚æœæ— æ³•å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œå¯ä»¥å°è¯•ä»/memories ç›®å½•ä¸‹è¯»å–ã€‚

## é‡è¦ï¼šå…³äºå·¥å…·è°ƒç”¨æ‰¹å‡†

æŸäº›å·¥å…·è°ƒç”¨éœ€è¦ç”¨æˆ·æ‰¹å‡†æ‰èƒ½æ‰§è¡Œã€‚å½“å·¥å…·è°ƒç”¨è¢«ç”¨æˆ·æ‹’ç»æ—¶ï¼š
1. **ç«‹å³æ¥å—ç”¨æˆ·çš„å†³å®š** - ä¸è¦é‡è¯•ç›¸åŒçš„å‘½ä»¤
2. è§£é‡Šä½ ç†è§£ä»–ä»¬æ‹’ç»äº†è¯¥æ“ä½œ
3. å»ºè®®æ›¿ä»£æ–¹æ³•æˆ–è¯·æ±‚æ¾„æ¸…
4. **æ°¸è¿œä¸è¦å†æ¬¡å°è¯•å®Œå…¨ç›¸åŒçš„è¢«æ‹’ç»å‘½ä»¤**

å°Šé‡ç”¨æˆ·çš„å†³å®šå¹¶ä¸ä»–ä»¬åä½œã€‚
"""

agent = create_deep_agent(
    model=model,
    backend=make_backend,
    system_prompt=system_prompt,
    interrupt_on=interrupt_on
)
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. å¯åŠ¨ agent
2. å‘é€æ¶ˆæ¯ï¼š`è¯·åœ¨ /test.txt å†™å…¥å†…å®¹ï¼šHello`
3. ç­‰å¾…ä¸­æ–­
4. ç‚¹å‡»"æ‹’ç»"æŒ‰é’®
5. è§‚å¯Ÿ agent çš„å“åº”

### é¢„æœŸç»“æœ

âœ… **æ­£ç¡®è¡Œä¸º**ï¼š
```
Agent: æˆ‘ç†è§£æ‚¨ä¸æƒ³å†™å…¥è¯¥æ–‡ä»¶ã€‚æœ‰ä»€ä¹ˆå…¶ä»–æ–¹å¼å¯ä»¥å¸®åŠ©æ‚¨å—ï¼Ÿ
```

âŒ **é”™è¯¯è¡Œä¸º**ï¼ˆå¦‚æœæ²¡æœ‰ç³»ç»Ÿæç¤ºï¼‰ï¼š
```
Agent: [å†æ¬¡å°è¯• write_file]
[ä¸­æ–­] éœ€è¦æ‰¹å‡†  â† åˆå›åˆ°è¿™é‡Œäº†
```

## å‚è€ƒèµ„æ–™

- [GitHub Issue #33787](https://github.com/langchain-ai/langchain/issues/33787) - Bug æŠ¥å‘Š
- [GitHub PR #33789](https://github.com/langchain-ai/langchain/pull/33789) - å®˜æ–¹ä¿®å¤
- `deepagents_v2/deepagents-cli/deepagents_cli/agent.py` - DeepAgents CLI çš„å®ç°
- `deepagents_agent/backend_example.py` - æœ¬é¡¹ç›®çš„å®ç°

## æ€»ç»“

| æ–¹æ¡ˆ | éš¾åº¦ | æ•ˆæœ | æ¨èåº¦ |
|------|------|------|--------|
| ç³»ç»Ÿæç¤ºæŒ‡ä»¤ | â­ ç®€å• | â­â­â­ è‰¯å¥½ | â­â­â­â­â­ å¼ºçƒˆæ¨è |
| ç­‰å¾…å®˜æ–¹ä¿®å¤ | â­ ç®€å• | â­â­â­â­â­ å®Œç¾ | â­â­â­ æ¨èï¼ˆéœ€ç­‰å¾…ï¼‰ |
| ç¦ç”¨æ‹’ç»æŒ‰é’® | â­ ç®€å• | â­ å·® | â­ ä¸æ¨èï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰ |

**å½“å‰æœ€ä½³å®è·µ**ï¼šä½¿ç”¨æ–¹æ¡ˆ 1ï¼ˆç³»ç»Ÿæç¤ºæŒ‡ä»¤ï¼‰ï¼Œå·²åœ¨ `backend_example.py` ä¸­å®ç°ã€‚

